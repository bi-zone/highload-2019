# Задание на Scala


## Легенда

Есть система, в которую входят пользователи. Для каждого входа записывается
время, IP-адрес и username пользователя.

Хочется анализировать подозрительную активность по входам в систему. Решено, что
подозрительными будут попытки входа под разными username с одного IP за
некоторое время.


## Задача

Ваша задача — сделать сервис, который определяет подозрительную активность.

В сервис поступают события с информацией о входах в виде потока данных по TCP.
Вам нужно реализовать TCP-сервер, принимающий эти события и подсчитывающий
ответ. TCP-клиент для передачи событий прилагается.

Решение должно быть на Scala.

Ниже подробна описана логика, которую необходимо реализовать. Для тестирования
мы даем ответ на задачу для небольшого количества событий. Чтобы получить
конечный ответ и участвовать в розыгрыше приза, необходимо будет обработать
3 000 000 событий.

Выбор фреймворка и решений остается на ваше усмотрение. Если не знаете, с чего
начать, возьмите заготовку
[решения на akka и akka streams (`solution-template/`)](solution-template/)
из этого репозитория.


## События

События поступают через TCP-соединение, в которое записываются строки в UTF-8.
Сообщение состоит из трех полей, разделенных пробелом, и оканчивается символом
новой строки (`\n`).

Пример сообщения:

```
1547339769 boomorah 168.72.31.248
```

где поля

* timestamp — unix time в секундах;
* username — строка, состоит только из символов a–z;
* IP-адрес.

Когда все события поступили, отправляется пустая строка и TCP-соединение
закрывается.

События строго отсортированы по времени. Timestamp каждого следующего события
всегда будет больше или равен timestamp предыдущего.


## Логика подсчета

Обработку нужно разбить на временные окна по 900 секунд. Окна отсчитываются от
timestamp `1547424000`. Начало временного отрезка включается в окно, конец не включается.

В каждом окне необходимо найти IP-адрес, с которого поступило наибольшее
количество **уникальных** username. Например, если в одном окне поступили такие
данные:

```
1547424000 127.0.0.2 frank
1547424025 127.0.0.1 mary
1547424050 127.0.0.2 frank
1547424100 127.0.0.1 mary
1547424150 127.0.0.2 alice
```

то по `127.0.0.1` был один уникальный username (`mary`), а по 127.0.0.2 — два
(`frank` и `alice`).

Если есть несколько IP-адресов, для которых количество уникальных username за
окно одинаково, необходимо лексикографически отсортировать эти IP-адреса и взять
самый младший.

Полученные для всех окон IP-адреса необходимо преобразовать в UTF-8, объединить
в одну строку (без разделителя) и посчитать от строки SHA1-хеш. Этот хеш и будет
ответом на задание.

Для получения ответа вам необходимо будет обработать 3 000 000 (3 млн) событий.

Для проверки решения на меньших объемах:

* для size=3000: 62e644302f9457c3d6c7b70189d8809a3ea5aa70
* для size=10000: 2057a9525adb38650064ac8d5ac0b212c57f7634
* для size=300000: f035aa074451f4d37f64d9508662d37a45cd7e8e


## Пример подсчета

Пусть размер окна — 10 секунд, начальный timestamp — 1400000000 и пришли
следующие события:

```
1400000000 bob 127.0.0.1
1400000002 alice 127.0.0.1
1400000002 frank 127.0.0.2
1400000009 alice 127.0.0.1
1400000010 mary 127.0.0.3
1400000011 mary 127.0.0.1
1400000012 mary 127.0.0.4
1400000013 misgiven 127.0.0.5
1400000016 camouflager 127.0.0.2
1400000018 labyrinth 127.0.0.2
1400000019 newburg 127.0.0.5
```

Первые 4 сообщения — первое окно, остальные — второе.

В первом окне выбираем `127.0.0.1`.

Во втором окне было по два уникальных username c `127.0.0.2` и `127.0.0.5`.
После лексикографической сортировки выбираем `127.0.0.2`.

Полученные в двух окнах IP-адреса объединяем и считаем по ним ответ:

```
sha1("127.0.0.1127.0.0.2") = 787680212e276b9650adf4ad50b63c3c08fffa7a
```


## TCP-клиент

К заданию приложен JAR-файл. Для его запуска требуется Java 8:

```
java -jar tcp-client.jar host port 100500 size
```

В `size` впишите нужное количество событий, а в `host` и `port` укажите
адрес и порт TCP-сервера, который вы реализуете. Например:

```
java -jar tcp-client.jar 127.0.0.1 7777 100500 3000000
```

После запуска клиент откроет TCP-соединение и передаст в него `size`
событий.


## Есть вопросы?

Приходите в наш телеграм-чат [askbizone](https://t.me/askbizone).
